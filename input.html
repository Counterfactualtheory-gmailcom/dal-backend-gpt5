<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAL Input</title>
  <style>
    :root { --brand:#F0C40F; }
    body{
      margin:16px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      line-height:1.45; background:#f7f7f7;
    }
    .card{
      background:#fff; border:3px solid var(--brand); border-radius:12px;
      padding:12px; max-width:900px; margin:0 auto;
      box-shadow:0 1px 6px rgb(0 0 0 / 6%);
    }
    h3{ margin:0 0 8px 0; font-size:18px; }
    textarea{
      width:100%; height:42vh; padding:12px; font:16px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      border-radius:10px; border:1px solid #ccc; resize:vertical; box-sizing:border-box;
    }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .btn{
      padding:10px 16px; border-radius:10px; border:0; cursor:pointer; font-weight:600; background:var(--brand);
    }
    .btn:hover{ background:#d9ae0d; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .meta{ font-size:12px; color:#555; margin-left:auto; }
    .tip{ font-size:12px; color:#666; margin-top:8px; }
    .status{ font-size:12px; margin-left:8px; color:#333; }
  </style>
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>
<body>
  <div class="card">
    <h3>Write your question</h3>
    <textarea id="t" placeholder="Type here…"></textarea>
    <div class="row">
      <button id="sendBtn" class="btn" type="button">Send to App</button>
      <span id="status" class="status" aria-live="polite"></span>
      <span id="count" class="meta">0 chars</span>
    </div>
    <div class="tip">Tip: Press <strong>Cmd/Ctrl + Enter</strong> to send. Line breaks are preserved.</div>
  </div>

  <script>
    const ta    = document.getElementById('t');
    const btn   = document.getElementById('sendBtn');
    const stat  = document.getElementById('status');
    const count = document.getElementById('count');

    // Character counter + simple draft restore
    try {
      const DRAFT_KEY = 'dal_input_draft';
      const saved = localStorage.getItem(DRAFT_KEY);
      if (saved) { ta.value = saved; }
      count.textContent = ta.value.length + ' chars';
      ta.addEventListener('input', () => {
        count.textContent = ta.value.length + ' chars';
        localStorage.setItem(DRAFT_KEY, ta.value);
      });
    } catch (_) {}

    function postToApp(payload) {
      // Thunkable extension expects a string; we send JSON for typed messages
      ThunkableWebviewerExtension.postMessage(
        typeof payload === 'string' ? payload : JSON.stringify(payload)
      );
    }

    function send(){
      const norm = ta.value.replace(/\r\n/g, '\n'); // normalize CRLF → \n
      const trimmed = norm.trim();
      if (trimmed.length < 2) {
        stat.textContent = 'Please enter some text first.';
        return;
      }
      // prevent rapid double sends
      btn.disabled = true;
      stat.textContent = 'Sending…';

      // typed message → Thunkable can filter on {type:"input"}
      postToApp({ type:'input', text: norm });

      // Optional: keep input (for edits). If you prefer to clear, uncomment:
      // ta.value = ''; count.textContent = '0 chars';

      // Re-enable UI shortly; the app still controls actual flow
      setTimeout(() => { btn.disabled = false; stat.textContent = 'Sent ✓'; }, 700);
    }

    // Click + Cmd/Ctrl+Enter
    btn.addEventListener('click', send);
    ta.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault(); send();
      }
    });

    // Handshake so the app knows the page is ready
    postToApp({ type:'ready-input' });
  </script>
</body>
</html>
